# Действующие лица.

1. Фронт. Он же WordPress.
2. Бек. Он же .net.
3. Юзер. Он же пользователь.

# Сценарий 1. Запрос поездок.

## Сценарий 1.1. Базовый.

Юзер заходит на сайт. Выбирает в фильтрах интересующие его фильтры. Фильтры будут рассмотрены отдельно.

Фронт получает запрос пользователя. Пересылает его беку.

Бек смотрит по БД, что можно дать юзеру. Отдаёт фронту.

Фронт отдаёт ответ юзеру. Вынужденная мера: фронт сверяется в ответе. Если в поездке нет мест или их недостаточно (поиск шёл на 3 места сразу, например), показывает поездку серым. По идее такие поездки не должны отображаться.

# Сценарий 2. Бронирование.

Бронирование невозможно совершить над поездкой, у которой старт/окончание в прошлом (проверяет бек в момент выдачи поискового запроса и фронт в момент открытия поездки и бронирования), над отменённой (проверяет бек в момент выдачи поискового запроса и фронт в момент открытия поездки и бронирования), над той, где водитель отказался вести конкретного юзера (проверяет фронт в момент открытия поездки и бронирования), свою поездку (проверяет бек в момент выдачи поискового запроса и фронт в момент открытия поездки и бронирования).

## Сценарий 2.1. Бронирование с оплатой на сайте.

- У оплаты на сайте есть проблема. Если водитель хочет предварительно посмотреть, кто едет (отзывы почитать, всё такое). Юзер-пассажир в таком случае не застрахован от отказа. Имхо, это неизбежное зло такого сервиса.

Юзер выбрал поездку. Нажал на "забронировать", выбрал оплату картой.

Фронт предоставил способ оплаты. Фрейм с оплатой, qr код - для сценария не важно. Важно, что средства не списываются, а замораживаются.

Юзер оплатил бронь. Фронт получил отмашку от сервиса оплаты, обновил фрейм. Обновил кол-во доступных мест в поездке в своей БД. Отправил в брокер на бек сообщение об изменении кол-ва доступных мест в поездке.

Фронт шлёт все уведомления. Пуш, тг, почта, смс. Водителю.

### Сценарий 2.1.1. Водитель подтверждает поездку.

Фронт меняет статус бронирования на подтверждённый.

### Сценарий 2.1.2. Водитель отклоняет поездку.

Бронь снимается. Фронт шлёт все уведомления. Пуш, тг, почта, смс. Пассажиру. Фронт возвращает деньги пассажиру. Поездка помечается отклонённой - чтобы пассажир не мог повторно забронировать эту поездку.

## Сценарий 2.2. Бронирование с оплатой на месте.

Юзер выбрал поездку. Нажал на "забронировать", выбрал оплату на месте.

Юзер подтвердил намерения, уверенность в дате поездки. Защита от дурака. Фрейм "Проверьте введённые данные".

Фронт обновил кол-во доступных мест в поездке в своей БД. Отправил в брокер на бек сообщение об изменении кол-ва доступных мест в поездке.

Фронт шлёт все уведомления. Пуш, тг, почта, смс.

### Сценарий 2.2.1. Водитель подтверждает поездку.

Фронт меняет статус бронирования на подтверждённый.

### Сценарий 2.2.2. Водитель отклоняет поездку.

Бронь снимается. Фронт шлёт все уведомления. Пуш, тг, почта, смс. Пассажиру. Поездка помечается отклонённой - чтобы пассажир не мог повторно забронировать эту поездку.

## Сценарий 2.3. Отмена брони (пассажиром).

### Сценарий 2.3.1. Отмена брони с оплатой на сайте.

Юзер выбрал поездку. Нажал на "Отменить бронь".

Защита от дурака. Фрейм "Выберете причину отмены поездки".

Фронт возвращает юзеру его средства. Отмечает в своей бд, что юзер сделал отмену (понятно, что оно и так есть в истории денежных транзакций, но важно, чтобы отмены можно было потом посчитать).

В случае большого числа отмен за последний период (скорее всего, месяц), выдать предупреждение. В случае превышения максимального числа отмен за период, залочить юзера.

Фронт обновил кол-во доступных мест в поездке в своей БД. Отправил в брокер на бек сообщение об изменении кол-ва доступных мест в поездке.

### Сценарий 2.3.2. Отмена брони с оплатой на  месте.

Юзер выбрал поездку. Нажал на "Отменить бронь".

Защита от дурака. Фрейм "Выберете причину отмены поездки".

Фронт отмечает в своей бд, что юзер сделал отмену.

В случае большого числа отмен за последний период (скорее всего, месяц), выдать предупреждение. В случае превышения максимального числа отмен за период, залочить юзера.

Фронт обновил кол-во доступных мест в поездке в своей БД. Отправил в брокер на бек сообщение об изменении кол-ва доступных мест в поездке.

# Сценарий 3. Поездки.

## Сценарий 3.1. Создание поездки.

Предусловия:

- юзер подтвердил право управлять транспортным средством.
- у юзера нет ни своих запланированных поездок на указываемое время, ни броней на чужие поездки на указанное время. Под "указанным временем" понимается пересечение времён.

Дополнение:

Юзер может начать планирование поездки даже если не подтвердил право управлять ТС или если есть пересечения времён. В таком случае фронт показывает юзеру предупреждение. Сама поездка сохраняется в виде черновика. Фронт не даёт перевести статус в какой-либо другой (исключение - deleted).

Юзер нажал на "Запланировать поездку".

Фронт открывает страницу редактирования поездки.

Юзер вводит все необходимые данные. Дата-время начала поездки, каждой промежуточной точки, окончания поездки. Промежуточные точки. Транспортное средство. Кол-во доступных для пассажиров мест. Комментарий к поездке (например, "Места в багаже практически нет. С большими сумками не бронируйте"). Номер телефона для связи (дефолтно - номер самого юзера). Цены на поездку целиком и на отдельные участки (про цены будет отдельный пункт). Способы оплаты. Моментальное подтверждение или с валидацией водителем.

Фронт проверяет данные. В случае нарушений показывает предупреждения.

### Сценарий 3.1.1. Сохранение как черновик.

Юзер нажимает "Сохранить как черновик". Фронт сохраняет поездку, оповещая об этом юзера.

### Сценарий 3.1.2. Публикация поездки

Юзер нажимает "Опубликовать поездку". Защита от дурака - фрейм "Проверьте введённые данные". Фронт сохраняет изменения. Шлёт брокером сообщение на бек о создании поездки.

## Сценарий 3.2. Редактирование поездки.

### Сценарий 3.2.1. Редактирование черновика.

В этом случае никаких ограничений на редактирование не накладывается. Юзер редактирует, как ему удобно.

Фронт сохраняет изменения по нажатию на кнопку "Сохранить изменения". Фронт показывает юзеру плашку об успешном сохранении изменений.

### Сценарий 3.2.2. Редактирование опубликованной поездки.

Доступно редактирование лишь комментария. При сохранении изменений всем юзерам-пассажирам в этой поездке фронт шлёт уведомление об изменениях. Подробнее уведомления будут рассмотрены отдельно.

### Сценарий 3.2.3. Удаление поездки.

#### Сценарий 3.2.3.1. Удаление пустой (без пассажиров) поездки.

Юзер жмёт кнопу "Удалить поездку". Защита от дурака - фрейм "Укажите причину отмены". Фронт отмечает в своей БД поездку как удалённую. Фронт шлёт брокером на бек сообщение об отмене поездки. Бек помечает поездку удалённой. Фронт сообщает юзеру об успешном удалении поездки.

#### Сценарий 3.2.3.2. Удаление поездки с пассажирами.

Юзер жмёт кнопку "Удалить поездку". Защита от дурака - фрейм "Укажите причину отмены". Наверху этого фрейма

# Сценарий 4. 