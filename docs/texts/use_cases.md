- [Действующие лица.](#действующие-лица)
- [Сценарий 1. Запрос поездок.](#сценарий-1-запрос-поездок)
	- [Сценарий 1.1. Базовый.](#сценарий-11-базовый)
		- [Сценарий 1.1.1. Фильтры.](#сценарий-111-фильтры)
- [Сценарий 2. Бронирование.](#сценарий-2-бронирование)
	- [Сценарий 2.1. Бронирование с оплатой на сайте.](#сценарий-21-бронирование-с-оплатой-на-сайте)
		- [Сценарий 2.1.1. Водитель подтверждает поездку.](#сценарий-211-водитель-подтверждает-поездку)
		- [Сценарий 2.1.2. Водитель отклоняет поездку.](#сценарий-212-водитель-отклоняет-поездку)
	- [Сценарий 2.2. Бронирование с оплатой на месте.](#сценарий-22-бронирование-с-оплатой-на-месте)
		- [Сценарий 2.2.1. Водитель подтверждает поездку.](#сценарий-221-водитель-подтверждает-поездку)
		- [Сценарий 2.2.2. Водитель отклоняет поездку.](#сценарий-222-водитель-отклоняет-поездку)
	- [Сценарий 2.3. Отмена брони (пассажиром).](#сценарий-23-отмена-брони-пассажиром)
		- [Сценарий 2.3.1. Отмена брони с оплатой на сайте.](#сценарий-231-отмена-брони-с-оплатой-на-сайте)
		- [Сценарий 2.3.2. Отмена брони с оплатой на месте.](#сценарий-232-отмена-брони-с-оплатой-на-месте)
- [Сценарий 3. Поездки.](#сценарий-3-поездки)
	- [Сценарий 3.1. Поездки для водителя.](#сценарий-31-поездки-для-водителя)
		- [Сценарий 3.1.1. Создание поездки.](#сценарий-311-создание-поездки)
			- [Сценарий 3.1.1.1. Сохранение как черновик.](#сценарий-3111-сохранение-как-черновик)
			- [Сценарий 3.1.1.2. Публикация поездки](#сценарий-3112-публикация-поездки)
			- [Сценарий 3.1.1.3. Создание регулярной поездки, сохранение как шаблон.](#сценарий-3113-создание-регулярной-поездки-сохранение-как-шаблон)
				- [Сценарий 3.1.1.3.1. Редактирование перед публикацией регулярной поездки.](#сценарий-31131-редактирование-перед-публикацией-регулярной-поездки)
		- [Сценарий 3.1.2. Редактирование поездки.](#сценарий-312-редактирование-поездки)
			- [Сценарий 3.1.2.1. Редактирование черновика.](#сценарий-3121-редактирование-черновика)
			- [Сценарий 3.1.2.2. Редактирование опубликованной поездки.](#сценарий-3122-редактирование-опубликованной-поездки)
			- [Сценарий 3.1.2.3. Удаление поездки.](#сценарий-3123-удаление-поездки)
				- [Сценарий 3.1.2.3.1. Удаление пустой (без пассажиров) поездки.](#сценарий-31231-удаление-пустой-без-пассажиров-поездки)
				- [Сценарий 3.1.2.3.2. Удаление поездки с пассажирами.](#сценарий-31232-удаление-поездки-с-пассажирами)
		- [Сценарий 3.1.3. Редактирование шаблона.](#сценарий-313-редактирование-шаблона)
		- [Сценарий 3.1.4. Валидация пассажира.](#сценарий-314-валидация-пассажира)
	- [Сценарий 3.2. Поездки для менеджера.](#сценарий-32-поездки-для-менеджера)
		- [Сценарий 3.2.1. Создание поездки.](#сценарий-321-создание-поездки)
			- [Сценарий 3.2.1.1. Сохранение как черновик.](#сценарий-3211-сохранение-как-черновик)
			- [Сценарий 3.2.1.2. Публикация поездки](#сценарий-3212-публикация-поездки)
			- [Сценарий 3.2.1.3. Создание регулярной поездки, сохранение как шаблон.](#сценарий-3213-создание-регулярной-поездки-сохранение-как-шаблон)
				- [Сценарий 3.2.1.3.1. Редактирование перед публикацией шаблонной поездки.](#сценарий-32131-редактирование-перед-публикацией-шаблонной-поездки)
		- [Сценарий 3.2.2. Редактирование поездки.](#сценарий-322-редактирование-поездки)
			- [Сценарий 3.2.2.1. Редактирование черновика.](#сценарий-3221-редактирование-черновика)
			- [Сценарий 3.2.2.2. Редактирование опубликованной поездки.](#сценарий-3222-редактирование-опубликованной-поездки)
			- [Сценарий 3.2.2.3. Удаление поездки.](#сценарий-3223-удаление-поездки)
				- [Сценарий 3.2.2.3.1. Удаление пустой (без пассажиров) поездки.](#сценарий-32231-удаление-пустой-без-пассажиров-поездки)
				- [Сценарий 3.2.2.3.2. Удаление поездки с пассажирами.](#сценарий-32232-удаление-поездки-с-пассажирами)
		- [Сценарий 3.2.3. Редактирование шаблона.](#сценарий-323-редактирование-шаблона)
		- [Сценарий 3.2.4. Валидация пассажира.](#сценарий-324-валидация-пассажира)
- [Сценарий 4. Действия с аккаунтом.](#сценарий-4-действия-с-аккаунтом)
	- [Сценарий 4.1. Регистрация.](#сценарий-41-регистрация)
	- [Сценарий 4.2. Редактирование аккаунта.](#сценарий-42-редактирование-аккаунта)
	- [Сценарий 4.3. Приобретение статуса водителя.](#сценарий-43-приобретение-статуса-водителя)
	- [Сценарий 4.4. Заполнение данных об автомобиле.](#сценарий-44-заполнение-данных-об-автомобиле)
	- [Сценарий 4.5. Связь менеджера и водителя.](#сценарий-45-связь-менеджера-и-водителя)
		- [Сценарий 4.5.1. Добавление связи.](#сценарий-451-добавление-связи)
		- [Сценарий 4.5.2. Удаление связи.](#сценарий-452-удаление-связи)
	- [Сценарий 4.6. Фото.](#сценарий-46-фото)
- [Далее идут не core-механики сервиса.](#далее-идут-не-core-механики-сервиса)
- [Сценарий 100. Чат с поддержкой.](#сценарий-100-чат-с-поддержкой)
- [Сценарий 101. Общий чат поездки.](#сценарий-101-общий-чат-поездки)
- [Сценарий 102. Чат менеджера и водителя с пассажиром.](#сценарий-102-чат-менеджера-и-водителя-с-пассажиром)
- [Сценарий 103. Оплата.](#сценарий-103-оплата)
- [Сценарий 104. Личный счёт пользователя.](#сценарий-104-личный-счёт-пользователя)
- [Сценарий 105. Отзывы.](#сценарий-105-отзывы)
- [Сценарий 106. Оповещения.](#сценарий-106-оповещения)
	- [Сценарий 106.1. Оповещения в системе.](#сценарий-1061-оповещения-в-системе)
	- [Сценарий 106.2. Внешние оповещения.](#сценарий-1062-внешние-оповещения)
- [Сценарий 107. Мобильная версия.](#сценарий-107-мобильная-версия)
- [Сценарий 108. Тёмная тема.](#сценарий-108-тёмная-тема)


# Действующие лица.

1. WordPress. Отвечает за популярные штуки и фронт. Например, за чат, за сервисы оплаты.
2. GeoService. Отвечает за основной функционал, связанный с географией.
3. DriverService. Отвечает за функционал, связанный с проверкой водителей.
4. Юзер. Он же пользователь. Может быть водителем, пассажиром, а также менеджером. На всё 1 аккаунт, а роль различается в зависимости от ситуации.

# Сценарий 1. Запрос поездок.

## Сценарий 1.1. Базовый.

Юзер заходит на сайт. Выбирает в фильтрах интересующие его фильтры. Фильтры будут рассмотрены отдельно.

WordPress получает запрос пользователя. Пересылает его GeoService'у.

GeoService смотрит по БД, что можно дать юзеру. Отдаёт WordPress'у.

WordPress отдаёт ответ юзеру. Вынужденная мера: WordPress сверяется в ответе. Если в поездке нет мест или их недостаточно (поиск шёл на 3 места сразу, например), показывает поездку серым. По идее такие поездки не должны отображаться.

### Сценарий 1.1.1. Фильтры.

Wordpress отображает пользователю и в дальнейшем передаёт GeoService'у следующие параметры:

* Сортировка. По возрастанию, убыванию. По цене, удалённости старта, удалённости конца, времени старта, времени конца.
* Фильтрация.
  + По точке и удалённости от неё старта (обязательный параметр)
  + По точке и удалённости от неё конца (обязательный)
  + Минимального времени выезда (обязательный, дефолтно - текущее время)
  + Максимального времени выезда (не обязательный)
  + Минимального времени прибытия (не обязательный)
  + Максимального времени прибытия (обязательный)
  + По цене минимальной (не обязательный)
  + По цене максимальной (не обязательный)
  + По кол-ву свободных мест (обязательный, дефолтно - 1)
  + Способам оплаты (обязательный, дефолтно "любой способ")
  + По подтверждению поездки водителем (обязательный, дефолтно "можно так, можно так")

> По времени максимальный период, который должен получиться - две недели (задаётся конфигами).
> 
> Также по времени - всё время WordPress передаёт с часовым поясом +0.

Пример запроса:

http://localhost:32770/api/Ride/SearchRides HTTP_POST

```
{
  "offset": 0,
  "limit": 0,
  "sortType": "byPrice",
  "sortDirection": "asc",
  "arrivalPoint": {
    "latitude": 0.123456,
    "longitude": 0.123456
  },
  "arrivalPointSearchRadiusKilometers": 10,
  "departurePoint": {
    "latitude": -10.2,
    "longitude": -10.2
  },
  "departurePointSearchRadiusKilometers": 20,
  "minArrivalTime": "2024-05-19T17:06:24.307Z",
  "maxArrivalTime": "2024-05-20T17:06:24.307Z",
  "minDepartureTime": "2024-05-19T17:06:24.307Z",
  "maxDepartureTime": "2024-05-20T17:06:24.307Z",
  "minPriceInRub": 100,
  "maxPriceInRub": 5000,
  "freeSeatsCount": 1,
  "paymentMethods": [
    "cash", "cashless"
  ],
  "validationMethods": [
    "withoutValidation", "validationBeforeAccessPassenger"
  ]
}
```

Пример ответа:

```
{
  "success": true,
  "data": [
    {
      "departureDistanceKilometers": 47.070934,
      "waypointDeparture": {
        "point": {
          "latitude": 0,
          "longitude": 0
        },
        "fullName": "Россия, Москва, метро Дмитровское",
        "nameToCity": "Россия, Москва",
        "arrival": "2024-05-20T16:13:45.337+00:00",
        "departure": "2024-05-20T16:13:45.337+00:00"
      },
      "arrivalDistanceKilometers": 15.689055,
      "waypointArrival": {
        "point": {
          "latitude": 1,
          "longitude": 1
        },
        "fullName": "Россия, Ростов-на-Дону, ул. М.Нагибина 18",
        "nameToCity": "Россия, Ростов-на-Дону",
        "arrival": "2024-05-21T16:13:45.337+00:00",
        "departure": null
      },
      "ride": {
        "id": "48300f3e-09df-4588-b724-b18ae1177e47",
        "authorId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
        "driverId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
        "created": "2024-05-19T16:30:07.433151+00:00",
        "availablePlacesCount": 2,
        "paymentMethods": [
          "cash"
        ],
        "validationMethod": "withoutValidation",
        "validationTimeBeforeDeparture": null,
        "afterRideValidationTimeoutAction": null,
        "waypoints": null,
        "legs": null
      },
      "priceInRub": 1000,
      "freePlaces": 2
    }
  ],
  "errors": null
}
```

# Сценарий 2. Бронирование.

Бронирование невозможно совершить над поездкой, у которой старт точки отправления в прошлом (проверяет GeoService в момент выдачи поискового запроса и WordPress в момент открытия поездки и бронирования), над отменённой (проверяет GeoService в момент выдачи поискового запроса и WordPress в момент открытия поездки и бронирования), над той, где водитель отказался вести конкретного пассажира (проверяет WordPress в момент открытия поездки и бронирования), свою поездку (проверяет WordPress в момент открытия поездки и бронирования).

В момент бронирования пассажир проходит капчу.

Пример запроса:

http://localhost:32770/api/Ride/MakeReservation HTTP_POST

```
{
  "passengerId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "rideId": "48300f3e-09df-4588-b724-b18ae1177e47",
  "passengersCount": 1,
  "waypointFrom": {
    "latitude": 0,
    "longitude": 0
  },
  "waypointTo": {
    "latitude": 1,
    "longitude": 1
  }
}
```

Пример ответа:

```
{
  "success": true,
  "data": {
    "id": "bd8bf5e6-cbe7-4775-94e5-0db7e22f03df",
    "rideId": "48300f3e-09df-4588-b724-b18ae1177e47",
    "passengerId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "peopleCount": 1,
    "leg": {
      "waypointFrom": {
        "latitude": 0,
        "longitude": 0
      },
      "waypointTo": {
        "latitude": 1,
        "longitude": 1
      },
      "priceInRub": 1000,
      "isBetweenNeighborPoints": true
    },
    "created": "2024-05-19T17:22:17.1426099+00:00"
  },
  "errors": null
}
```

## Сценарий 2.1. Бронирование с оплатой на сайте.

> У оплаты на сайте есть проблема. Если водитель хочет предварительно посмотреть, кто едет (отзывы почитать, всё такое). Юзер-пассажир в таком случае не застрахован от отказа. Имхо, это неизбежное зло такого сервиса.

Пассажир выбрал поездку. Нажал на "забронировать", выбрал оплату картой.

WordPress предоставил способ оплаты. Фрейм с оплатой, qr код - для сценария не важно. Важно, что средства не списываются, а замораживаются.

Пассажир оплатил бронь. WordPress получил отмашку от сервиса оплаты, обновил фрейм. Обновил кол-во доступных мест в поездке в своей БД. Отправил в брокер на GeoService сообщение об изменении кол-ва доступных мест в поездке.

WordPress шлёт все уведомления. Пуш, тг, почта, смс. Водителю.

### Сценарий 2.1.1. Водитель подтверждает поездку.

Подтверждение может быть как ручным, так и автоматическим (по истечении времени на подтверждение).

WordPress меняет статус бронирования на подтверждённый.

### Сценарий 2.1.2. Водитель отклоняет поездку.

Отказ может быть как ручным, так и автоматическим (по истечении времени на отказ).

Бронь снимается. WordPress шлёт все уведомления. Пуш, тг, почта, смс. Пассажиру. WordPress возвращает деньги пассажиру. Поездка помечается отклонённой - чтобы пассажир не мог повторно забронировать эту поездку.

## Сценарий 2.2. Бронирование с оплатой на месте.

Пассажир выбрал поездку. Нажал на "забронировать", выбрал оплату на месте.

Пассажир подтвердил намерения, уверенность в дате поездки. Защита от дурака. Фрейм "Проверьте введённые данные".

WordPress обновил кол-во доступных мест в поездке в своей БД. Отправил в брокер на GeoService сообщение об изменении кол-ва доступных мест в поездке.

WordPress шлёт все уведомления. Пуш, тг, почта, смс.

### Сценарий 2.2.1. Водитель подтверждает поездку.

Подтверждение может быть как ручным, так и автоматическим (по истечении времени на подтверждение).

WordPress меняет статус бронирования на подтверждённый.

### Сценарий 2.2.2. Водитель отклоняет поездку.

Отказ может быть как ручным, так и автоматическим (по истечении времени на отказ).

Бронь снимается. WordPress шлёт все уведомления. Пуш, тг, почта, смс. Пассажиру. Поездка помечается отклонённой - чтобы пассажир не мог повторно забронировать эту поездку.

## Сценарий 2.3. Отмена брони (пассажиром).

Пример запроса:

http://localhost:32770/api/Ride/CancelReservation HTTP_POST

```
{
  "id": "bd8bf5e6-cbe7-4775-94e5-0db7e22f03df"
}
```

Пример ответа:

```
{
  "success": true,
  "data": null,
  "errors": null
}
```

### Сценарий 2.3.1. Отмена брони с оплатой на сайте.

Пассажир выбрал поездку. Нажал на "Отменить бронь".

Защита от дурака. Фрейм "Выберете причину отмены поездки".

WordPress возвращает пассажиру его средства. Отмечает в своей бд, что юзер сделал отмену (понятно, что оно и так есть в истории денежных транзакций, но важно, чтобы отмены можно было потом посчитать).

В случае большого числа отмен за последний период (скорее всего, месяц), выдать предупреждение. В случае превышения максимального числа отмен за период, залочить юзера.

WordPress обновил кол-во доступных мест в поездке в своей БД. Отправил в брокер на GeoService сообщение об изменении кол-ва доступных мест в поездке.

### Сценарий 2.3.2. Отмена брони с оплатой на месте.

Пассажир выбрал поездку. Нажал на "Отменить бронь".

Защита от дурака. Фрейм "Выберете причину отмены поездки".

WordPress отмечает в своей бд, что юзер сделал отмену.

В случае большого числа отмен за последний период (скорее всего, месяц), выдать предупреждение. В случае превышения максимального числа отмен за период, залочить юзера.

WordPress обновил кол-во доступных мест в поездке в своей БД. Отправил в брокер на GeoService сообщение об изменении кол-ва доступных мест в поездке.

# Сценарий 3. Поездки.

Поездка для создания и редактирования доступна водителю и менеджеру. При этом поездка, созданная менеджером, недоступна для редактирования водителю, если только менеджер не указал обратное.

## Сценарий 3.1. Поездки для водителя.

### Сценарий 3.1.1. Создание поездки.

Пример запроса:

http://localhost:32770/api/Ride/CreateRide HTTP_POST

```
{
  "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "authorId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "driverId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "availablePlacesCount": 3,
  "paymentMethods": [
    "cashless"
  ],
  "validationMethod": "withoutValidation",
  "waypoints": [
    {
      "point": {
        "latitude": 0,
        "longitude": 0
      },
      "fullName": "Россия, Москва, ул. Названия, д.14",
      "nameToCity": "Россия, Москва",
      "arrival": "2024-05-22T17:25:37.252Z",
      "departure": "2024-05-22T17:25:37.252Z"
    },
    {
      "point": {
        "latitude": 1,
        "longitude": 1
      },
      "fullName": "Россия, Ростов-на-Дону, ул. Названия, д.8",
      "nameToCity": "Россия, Ростов-на-Дону",
      "arrival": "2024-05-22T20:00:00.000Z",
      "departure": "2024-05-22T20:30:00.000Z"
    },
    {
      "point": {
        "latitude": 2,
        "longitude": 2
      },
      "fullName": "Россия, Сочи, ул. Названия, д.1",
      "nameToCity": "Россия, Сочи",
      "arrival": "2024-05-23T01:00:00.000Z",
      "departure": null
    }
  ],
  "legs": [
    {
      "waypointFrom": {
        "latitude": 0,
        "longitude": 0
      },
      "waypointTo": {
        "latitude": 1,
        "longitude": 1
      },
      "priceInRub": 500
    },
    {
      "waypointFrom": {
        "latitude": 1,
        "longitude": 1
      },
      "waypointTo": {
        "latitude": 2,
        "longitude": 2
      },
      "priceInRub": 1000
    }
  ]
}
```

Пример ответа:

```
{
  "success": true,
  "data": {
    "id": "f76dd9b5-bbd3-4b99-a21b-25db8786b350",
    "authorId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "driverId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "created": "2024-05-19T17:29:52.7231348+00:00",
    "availablePlacesCount": 3,
    "paymentMethods": [
      "cashless"
    ],
    "validationMethod": "withoutValidation",
    "validationTimeBeforeDeparture": null,
    "afterRideValidationTimeoutAction": null,
    "waypoints": [
      {
        "point": {
          "latitude": 0,
          "longitude": 0
        },
        "fullName": "Россия, Москва, ул. Названия, д.14",
        "nameToCity": "Россия, Москва",
        "arrival": "2024-05-22T17:25:37.252+00:00",
        "departure": "2024-05-22T17:25:37.252+00:00"
      },
      {
        "point": {
          "latitude": 1,
          "longitude": 1
        },
        "fullName": "Россия, Ростов-на-Дону, ул. Названия, д.8",
        "nameToCity": "Россия, Ростов-на-Дону",
        "arrival": "2024-05-22T20:00:00+00:00",
        "departure": "2024-05-22T20:30:00+00:00"
      },
      {
        "point": {
          "latitude": 2,
          "longitude": 2
        },
        "fullName": "Россия, Сочи, ул. Названия, д.1",
        "nameToCity": "Россия, Сочи",
        "arrival": "2024-05-23T01:00:00+00:00",
        "departure": null
      }
    ],
    "legs": [
      {
        "waypointFrom": {
          "latitude": 0,
          "longitude": 0
        },
        "waypointTo": {
          "latitude": 1,
          "longitude": 1
        },
        "priceInRub": 500,
        "isBetweenNeighborPoints": true
      },
      {
        "waypointFrom": {
          "latitude": 1,
          "longitude": 1
        },
        "waypointTo": {
          "latitude": 2,
          "longitude": 2
        },
        "priceInRub": 1000,
        "isBetweenNeighborPoints": true
      }
    ]
  },
  "errors": null
}
```

Предусловия:

- у водителя нет ни своих запланированных поездок на указываемое время, ни броней на чужие поездки на указанное время. Под "указанным временем" понимается пересечение времён.

Дополнение:

- Водитель может начать планирование поездки даже если не имеет статус водителя (не ввёл либо не дождался проверки водительского удостоверения) или если есть пересечения времён. В таком случае WordPress показывает водителю предупреждение. Сама поездка сохраняется в виде черновика. WordPress не даёт перевести статус в какой-либо другой (исключение - deleted).

Водитель нажал на "Запланировать поездку".

WordPress открывает страницу редактирования поездки.

Водитель вводит все необходимые данные. Дата-время начала поездки, каждой промежуточной точки, окончания поездки. Промежуточные точки. Транспортное средство. Кол-во доступных для пассажиров мест. Комментарий к поездке (например, "Места в багаже практически нет. С большими сумками не бронируйте"). Цены на поездку целиком и на отдельные участки (про цены будет отдельный пункт). Способы оплаты. Моментальное подтверждение или с валидацией водителем. Максимальное время на валидацию пассажира. Принимать без валидации либо закрыть для бронирования поездку по истечении указанного промежутка.

WordPress проверяет данные. В случае нарушений показывает предупреждения.

В момент начала ввода точек WordPress отправляет запросы GeoService для получения подсказок.

В момент ввода точек (то есть когда юзер окончательно ввёл адрес для точки - нажал enter, tab или просто ушёл на другое поле ввода) WordPress отправляет запросы GeoService для получения рекомендаций цен.

#### Сценарий 3.1.1.1. Сохранение как черновик.

Водитель нажимает "Сохранить как черновик". WordPress сохраняет поездку, оповещая об этом водителя.

#### Сценарий 3.1.1.2. Публикация поездки

Водитель нажимает "Опубликовать поездку". Защита от дурака - фрейм "Проверьте введённые данные". WordPress сохраняет изменения. Шлёт сообщение на GeoService о создании поездки.

#### Сценарий 3.1.1.3. Создание регулярной поездки, сохранение как шаблон.

Водитель ставит галочку "Поездка регулярна". WordPress показывает дополнительные параметры поездки. Такие как "По дням недели", "По чётным числам месяца", "По нечётным числам месяца", "Раз в несколько дней", "Подтверждать создание поездки", "Создавать несколько поездок наперёд", "Создавать поездки за несколько дней до старта", "Шаблон активен". При активации галочки "Поездка регулярна" кнопка "Опубликовать поездку" становится неактивной. Вместо неё появляется кнопка "Опубликовать следующую поездку: Город А - Город Б, yyyy-MM-ddTHH:mm - yyyy-MM-ddTHH:mm". Вместо кнопки "Сохранить как черновик" появляется кнопка "Сохранить шаблон".

##### Сценарий 3.1.1.3.1. Редактирование перед публикацией регулярной поездки.

Если водитель пожелал подтверждать создание поездок, то создаваемые по шаблону поездки сохраняются как черновики. В том числе в момент нажатия на кнопку "Опубликовать следующую поездку...". Только в последнем случае сразу открывается фрейм с редактированием черновика.

### Сценарий 3.1.2. Редактирование поездки.

Как было упомянуто выше, редактирование водителю доступно, если он сам себе создаёт поездку, или если менеджер разрешил редактирование.

#### Сценарий 3.1.2.1. Редактирование черновика.

В этом случае никаких ограничений на редактирование не накладывается. Водитель редактирует, как ему удобно.

WordPress сохраняет изменения по нажатию на кнопку "Сохранить изменения". WordPress показывает юзеру плашку об успешном сохранении изменений.

#### Сценарий 3.1.2.2. Редактирование опубликованной поездки.

Доступно редактирование лишь комментария и кол-ва доступных мест. При изменении комментария при сохранении изменений всем юзерам-пассажирам в этой поездке WordPress шлёт уведомление об изменениях. Подробнее уведомления будут рассмотрены отдельно.

При редактировании кол-ва доступных мест WordPress проверяет возможность таких изменений. К примеру, если заявлено 4 места, из них 2 уже заняты, а водитель хочет снизить кол-во доступных мест до 2, то всё пройдёт успешно. До 1 - ошибка. До 3 - успешно. Хочет увеличить - будет проверка такой возможности в соответствии с выбранным авто.

#### Сценарий 3.1.2.3. Удаление поездки.

Пример запроса:

http://localhost:32770/api/Ride/DeleteRide HTTP_POST

```
{
  "id": "f6233226-0b91-416f-8b9d-ae871705d5c7"
}
```

Пример ответа:

```
{
  "success": true,
  "data": null,
  "errors": null
}
```

##### Сценарий 3.1.2.3.1. Удаление пустой (без пассажиров) поездки.

Водитель жмёт кнопу "Удалить поездку". Защита от дурака - фрейм "Укажите причину отмены". WordPress отмечает в своей БД поездку как удалённую. WordPress шлёт на GeoService сообщение об отмене поездки. GeoService помечает поездку удалённой. WordPress сообщает юзеру об успешном удалении поездки.

##### Сценарий 3.1.2.3.2. Удаление поездки с пассажирами.

Водитель жмёт кнопку "Удалить поездку". Защита от дурака - фрейм "Укажите причину отмены". Наверху этого фрейма светится предупреждение о возможности бана. Водитель подтверждает серьёзность своих намерений. Всем пассажирам рассылается уведомление и по необходимости возвращаются деньги.

### Сценарий 3.1.3. Редактирование шаблона.

Ничего интересного. Все поля доступны на редактирование. Важно, что это никак не аффектит уже созданные по шаблону поездки.

### Сценарий 3.1.4. Валидация пассажира.

Важный аспект:

- Без валидации пассажир не занимает место в машине. То есть может сложиться ситуация, что будет забронировано 5 мест из 4. В таком случае одному человеку придётся отказать.

Если водитель пожелал валидировать пассажира, то в момент брони поездки пассажиром водитель получает уведомление о бронировании. Далее водитель должен утвердить участие пассажира. Валидация должна быть не позднее, чем за указанный промежуток в параметре "Максимальное время на валидацию пассажира". При отсутствии валидации к указанному времени применить указанное действие (принимать всех без валидации или отказывать всем).

В случае валидации пассажира (не важно, ручной или автоматической) идёт проверка на наличие свободных мест для остальных забронировавших. Если мест не остаётся, оставшимся людям приходит отказ.

## Сценарий 3.2. Поездки для менеджера.

Менеджер может создавать поездки для своих водителей (так как отношение водителей и менеджеров будет рассмотрено позже, то кратко упомяну здесь: связь многие ко многим. Один водитель может ссылаться на 0..n менеджеров, менеджер может ссылаться на 0..n водителей).

### Сценарий 3.2.1. Создание поездки.

Глобально создание поездки менеджером отличается от создания поездки водителем тем, что менеджер может выбрать водителя на поездку и имеет временной лаг на редактирование поездки даже после публикации.

WordPress открывает страницу редактирования поездки.

Менеджер вводит все необходимые данные. Дата-время начала поездки, каждой промежуточной точки, окончания поездки. Промежуточные точки. Транспортное средство. Кол-во доступных для пассажиров мест. Комментарий к поездке (например, "Места в багаже практически нет. С большими сумками не бронируйте"). Цены на поездку целиком и на отдельные участки (про цены будет отдельный пункт). Способы оплаты. Моментальное подтверждение или с валидацией менеджером или водителем. Максимальное время на валидацию пассажира. Принимать без валидации либо закрыть для бронирования поездку по истечении указанного промежутка. Водитель. Возможность редактирования поездки водителем. Возможность валидации пассажира водителем.

Напротив параметров "Водитель", "Транспортное средство" появляется параметр "Окончательное значение". Если оно стоит в false, то пассажирам в этом месте показывается предупреждение, что выбор не окончательный. Параметр "Окончательное значение" доступен для изменения с false на true, но не наоборот (подробнее в пункте о редактировании поездки).

Менеджер может указать как своё транспортное средство, так и транспортное средство водителя.

WordPress проверяет данные. В случае нарушений показывает предупреждения.

В момент начала ввода точек WordPress отправляет запросы GeoService для получения подсказок.

В момент ввода точек (то есть когда юзер окончательно ввёл адрес для точки - нажал enter, tab или просто ушёл на другое поле ввода) WordPress отправляет запросы GeoService для получения рекомендаций цен.

WordPress показывает ещё 1 параметр поездки: максимальное время на подтверждение данных. Хоть и является голым DateTime, WordPress показывает заранее заготовленные варианты: 6 часов до поездки, 12 часов до поездки, 24 часа до поездки, 3 дня до поездки, неделя до поездки. Этот параметр тесно связан с параметром "Окончательное значение". Если к указанному времени поле пустое - поездка удаляется (с вытекающей возможностью бана). Если поле не пустое, то насильственно ставится параметр "Окончательное значение".

#### Сценарий 3.2.1.1. Сохранение как черновик.

Менеджер нажимает "Сохранить как черновик". WordPress сохраняет поездку, оповещая об этом менеджера (в будущем и водителя).

#### Сценарий 3.2.1.2. Публикация поездки

Менеджер нажимает "Опубликовать поездку". Защита от дурака - фрейм "Проверьте введённые данные". WordPress сохраняет изменения. Шлёт сообщение на GeoService о создании поездки.

#### Сценарий 3.2.1.3. Создание регулярной поездки, сохранение как шаблон.

Менеджер ставит галочку "Поездка регулярна". WordPress показывает дополнительные параметры поездки. Такие как "По дням недели", "По чётным числам месяца", "По нечётным числам месяца", "Раз в несколько дней", "Подтверждать создание поездки", "Создавать несколько поездок наперёд", "Создавать поездки за несколько дней до старта", "Шаблон активен". При активации галочки "Поездка регулярна" кнопка "Опубликовать поездку" становится неактивной. Вместо неё появляется кнопка "Опубликовать следующую поездку: Город А - Город Б, yyyy-MM-ddTHH:mm - yyyy-MM-ddTHH:mm". Вместо кнопки "Сохранить как черновик" появляется кнопка "Сохранить шаблон".

##### Сценарий 3.2.1.3.1. Редактирование перед публикацией шаблонной поездки.

Если менеджер пожелал подтверждать создание поездок, то создаваемые по шаблону поездки сохраняются как черновики. В том числе в момент нажатия на кнопку "Опубликовать следующую поездку...". Только в последнем случае сразу открывается фрейм с редактированием черновика.


### Сценарий 3.2.2. Редактирование поездки.

Как было упомянуто выше, редактирование водителю доступно, только если менеджер разрешил редактирование. В противном случае редактирование доступно лишь менеджеру.

Редактирование менеджером отличается лишь возможностью сменить водителя и машину (если только не стоит галочка "Окончательное значение"). В будущем появится возможность отсылать уведомление водителю об изменениях поездки.

#### Сценарий 3.2.2.1. Редактирование черновика.

В этом случае никаких ограничений на редактирование не накладывается. Менеджер редактирует, как ему удобно.

WordPress сохраняет изменения по нажатию на кнопку "Сохранить изменения". WordPress показывает юзеру плашку об успешном сохранении изменений.

#### Сценарий 3.2.2.2. Редактирование опубликованной поездки.

Доступно редактирование лишь комментария, кол-ва доступных мест, и водителя и машину (если только не стоит галочка "Окончательное значение"). При изменении комментария при сохранении изменений всем юзерам-пассажирам в этой поездке WordPress шлёт уведомление об изменениях. Подробнее уведомления будут рассмотрены отдельно.

При редактировании кол-ва доступных мест WordPress проверяет возможность таких изменений. К примеру, если заявлено 4 места, из них 2 уже заняты, а водитель хочет снизить кол-во доступных мест до 2, то всё пройдёт успешно. До 1 - ошибка. До 3 - успешно. Хочет увеличить - будет проверка такой возможности в соответствии с выбранным авто.

В будущем водителю будут приходить уведомления.

#### Сценарий 3.2.2.3. Удаление поездки.

Удалять поездку может только менеджер.

##### Сценарий 3.2.2.3.1. Удаление пустой (без пассажиров) поездки.

Менеджер жмёт кнопу "Удалить поездку". Защита от дурака - фрейм "Укажите причину отмены". WordPress отмечает в своей БД поездку как удалённую. WordPress шлёт на GeoService сообщение об отмене поездки. GeoService помечает поездку удалённой. WordPress сообщает юзеру об успешном удалении поездки.

##### Сценарий 3.2.2.3.2. Удаление поездки с пассажирами.

Менеджер жмёт кнопку "Удалить поездку". Защита от дурака - фрейм "Укажите причину отмены". Наверху этого фрейма светится предупреждение о возможности бана. Менеджер подтверждает серьёзность своих намерений. Всем пассажирам рассылается уведомление и по необходимости возвращаются деньги.

### Сценарий 3.2.3. Редактирование шаблона.

Ничего интересного. Все поля доступны на редактирование. Важно, что это никак не аффектит уже созданные по шаблону поездки.

### Сценарий 3.2.4. Валидация пассажира.

Важный аспект:

- Без валидации юзер не занимает место в машине. То есть может сложиться ситуация, что будет забронировано 5 мест из 4. В таком случае одному человеку придётся отказать.
- Валидация пассажира доступна менеджеру. При установленной галочке о валидации пассажира водителем, такая возможность появляется и у водителя.

Если менеджер пожелал валидировать пассажира, то в момент брони поездки пассажиром менеджер получает уведомление о бронировании. Далее менеджер должен утвердить участие пассажира. Валидация должна быть не позднее, чем за указанный промежуток в параметре "Максимальное время на валидацию пассажира". При отсутствии валидации к указанному времени применить указанное действие (принимать всех без валидации или отказывать всем).

В случае валидации пассажира (не важно, ручной или автоматической) идёт проверка на наличие свободных мест для остальных забронировавших. Если мест не остаётся, оставшимся людям приходит отказ.

# Сценарий 4. Действия с аккаунтом.

## Сценарий 4.1. Регистрация.

Аккаунт един для пассажира, водителя и менеджера. Регистрация идёт по номеру телефона. Дефолтно делаем двухфакторную аутентификацию. Юзер может от неё отказаться.

> Можно зарегистрироваться через госуслуги. Это на будущее.

При регистрации необходимо указать полное ФИО. Есть галочка "Скрывать настоящие данные" - в таком случае пассажирам и водителям отображаться должно лишь первых 3 символа фамилии (печально получится, если фамилия короче. Но пока забиваем на этот кейс), 3 звёздочки, инициалы и пол.

Пол. Можно не указывать.

Дата рождения. Можно не указывать.

Почта. Можно не указывать. Если почта есть - становится активной галочка "Получать новости на почту".

Прохождение капчи.

GeoService'у непроверенные персональные данные не нужны. Однако ему нужен юзер. Поэтому нужно его зарегистрировать и в GeoService'е. Пример запроса:

http://localhost:32770/api/User/RegisterUser HTTP_POST

```
{
  "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6"
}
```

Пример ответа:

```
{
  "success": true,
  "data": null,
  "errors": null
}
```

## Сценарий 4.2. Редактирование аккаунта.

На этапе редактирования аккаунта можно отредактировать все поля. А также можно ввести паспортные данные. Паспортные данные являются обязательными для приобретения статуса водителя. При наличии паспортных данных нельзя поменять персональные данные (например, имя) - данные должны соответствовать паспортным. Однако можно ввести новый паспорт - тогда и персональные данные сменить можно.

Пример запроса:

http://localhost:32770/api/User/UpdatePersonData HTTP_POST

```
{
  "userId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "person": {
    "passportSeries": 0123,
    "passportNumber": 012012,
    "firstName": "string",
    "lastName": "string",
    "secondName": "string",
    "birthDate": "2024-05-19T17:59:25.629Z"
  }
}
```

Пример ответа:

```
{
  "success": true,
  "data": null,
  "errors": null
}
```

## Сценарий 4.3. Приобретение статуса водителя.

Как такового статуса водителя нет. Просто не имея данных о транспортном средстве, о водительском удостоверении не получится опубликовать поездку.

Будущий водитель заполняет данные о водительском удостоверении. Заполняет капчу. WordPress отправляет запрос в DriverService на проверку данных водителя. Проверка происходит хоть и быстро, но не моментально. Водитель вынужден ждать.

## Сценарий 4.4. Заполнение данных об автомобиле.

На одном аккаунте может быть несколько транспортных средств и одно транспортное средство может встретиться у разных людей.

При заполнении данных о транспортном средстве пользователь вводит только VIN номер. И капчу. Все прочие данные (список будет ближе к реализации DriverService. Но однозначно там есть регистрационный номер, кол-во мест (всего, включая водительское), цвет (если авто зарегистрировано в рф)) мы заполняем самостоятельно - эти данные предоставит DriverService. Пользователь может только через письмо поддержке сообщить, что данные неверны. Как будем разруливать - на месте разберёмся.

Пользователь вправе поставить галочку "скрывать регистрационный номер".

Пример запроса:

http://localhost:32770/api/Car/SearchCar HTTP_POST

```
{
  "vin": "YV1TS90D811174550"
}
```

Пример ответа:

```
{
  "success": true,
  "data": {
    "id": "db637ea1-9455-4188-9c97-cdf44eea19e2",
    "created": "2024-05-20T05:58:45.95916+00:00",
    "vin": "YV1TS90D811174550",
    "registrationNumber": "А123ВС 09",
    "doesVinAndRegistrationNumberMatches": true,
    "name": "Жёлтый Test Fiat",
    "seatsCount": 5,
    "passengerSeatsCount": 4
  },
  "errors": null
}
```

## Сценарий 4.5. Связь менеджера и водителя.

Один менеджер может управлять несколькими водителями и один водитель может подчиняться нескольким менеджерам.

### Сценарий 4.5.1. Добавление связи.

Инициатором добавления связи является менеджер.

Менеджер нажимает на "Добавить водителя", вводит его id (uuid). WordPress показывает ФИО пользователя. Важно, что показываются только люди, имеющие водительское удостоверение. Менеджер подтверждает корректность ФИО водителя.

WordPress отправляет водителю запрос на добавление менеджера. У водителя есть 24 часа (время настраивается конфигами) на то, чтобы принять запрос. В противном случае запрос считается просроченным. Важно, что если уже есть запрос этому водителю от этого менеджера, повторно запрос не отправляется, а менеджеру показывается предупреждение, что запрос был отправлен ранее и всё ещё действителен.

Водитель принимает запрос.

### Сценарий 4.5.2. Удаление связи.

Удалить связь могут как менеджер, так и водитель.

В случае удаления связи отменяются поездки, где водитель указан с пометкой "Финальное значение", а также вносятся изменения в шаблоны поездок, где был указан этот водитель - там ставится пустое значение. Счётчик нарушений за такую отмену поездок начисляется и водителю, и менеджеру.

При удалении связи необходимо пройти защиту от дурака - указать причину удаления, а также пройти капчу.

## Сценарий 4.6. Фото.

Пользователь вправе выложить 1 фото себя и до 10 фото каждого автомобиля. При добавлении фото, нарушающих правила пользования сервисом - бан сразу, без всяких счётчиков. Проверка фото в ручном режиме (по крайней мере пока).

# Сценарий 5. География.

Всё делается через GeoService. В случае карт, что рендерятся у пользователя на устройстве, нужно будет договариваться о контракте.

Важно, что в случае географии будет 2 поля Success. Одно - от глобального враппера над всеми запросами, одно - от враппера над запросами географии. Пример:

```
{
  "success": true,
  "data": {
    "results": null,
    "success": false
  },
  "errors": null
}
```

Сам по себе запрос отработал корректно. Поэтому глобальный Success true. Но гео сервис отработал некорректно (в рамках примера - был запрошен адрес "а"), поэтому внутри Success false.

## Сценарий 5.1. Построение маршрутов.

Не готово.

## Сценарий 5.2. Подсказки.

Подсказки нужны, чтобы пользователь мог выбрать из выпадающего списка свой город/улицу/так далее, не вводя их полностью. Пример:

http://localhost:32770/api/Goecode/GetSuggest HTTP_POST

```
{
  "input": "ярос"
}
```

Пример ответа:

```
{
  "success": true,
  "data": {
    "results": [
      {
        "formattedAddress": "Ярославль",
        "title": "Ярославль",
        "subTitle": null,
        "uri": "ymapsbm1://geo?data=Cgg1MzA1NzI0MRIg0KDQvtGB0YHQuNGPLCDQr9GA0L7RgdC70LDQstC70Yw,"
      },
      {
        "formattedAddress": "Москва, Комсомольская площадь, 5",
        "title": "Ярославский вокзал",
        "subTitle": "Железнодорожный вокзал · Москва, Комсомольская площадь, 5",
        "uri": "ymapsbm1://org?oid=1085018813"
      },
      {
        "formattedAddress": "Москва, Ярославское шоссе",
        "title": "Ярославское шоссе",
        "subTitle": "Москва",
        "uri": "ymapsbm1://geo?data=CggxMDA1MDM5MBI90KDQvtGB0YHQuNGPLCDQnNC-0YHQutCy0LAsINCv0YDQvtGB0LvQsNCy0YHQutC-0LUg0YjQvtGB0YHQtQ,,"
      },
      {
        "formattedAddress": "Ярославская область",
        "title": "Ярославская область",
        "subTitle": null,
        "uri": "ymapsbm1://geo?data=Cgg1MzAwMDA5MhIz0KDQvtGB0YHQuNGPLCDQr9GA0L7RgdC70LDQstGB0LrQsNGPINC-0LHQu9Cw0YHRgtGM"
      },
      {
        "formattedAddress": "Ярославль, площадь Ярославль-Главный, 1А",
        "title": "Железнодорожный вокзал Ярославль-Главный",
        "subTitle": "Железнодорожный вокзал · Ярославль, площадь Ярославль-Главный, 1А",
        "uri": "ymapsbm1://org?oid=1079037981"
      },
      {
        "formattedAddress": "Ярославский район",
        "title": "Ярославский район",
        "subTitle": null,
        "uri": "ymapsbm1://geo?data=Cgg1MzAwMjE0NxIv0KDQvtGB0YHQuNGPLCDQr9GA0L7RgdC70LDQstGB0LrQuNC5INGA0LDQudC-0L0,"
      },
      {
        "formattedAddress": "городской округ Ярославль",
        "title": "городской округ Ярославль",
        "subTitle": null,
        "uri": "ymapsbm1://geo?data=Cgg1MzAwMjE0OBI-0KDQvtGB0YHQuNGPLCDQs9C-0YDQvtC00YHQutC-0Lkg0L7QutGA0YPQsyDQr9GA0L7RgdC70LDQstC70Yw,"
      }
    ],
    "success": true
  },
  "errors": null
}
```

Важно обратить внимание, что в поле uri содержится почти что магическая строка. Она вроде бы урл, а вроде и нет. Это нормально. Воспринимайте её как уникальный строковый ключ.

## Сценарий 5.3. Получение координат по адресу.

Пример запроса:

http://localhost:32770/api/Goecode/GetGeocodeByAddress HTTP_POST

```
{
  "input": "Москва, Комсомольская площадь, 5"
}
```

Пример ответа:

```
{
  "success": true,
  "data": {
    "success": true,
    "geoobjects": [
      {
        "formattedAddress": "Россия, Москва, Комсомольская площадь, 5",
        "toLocalityName": "Россия, Центральный федеральный округ, Москва, Москва, Комсомольская площадь, 5",
        "point": {
          "latitude": 55.776816,
          "longitude": 37.657332
        }
      }
    ]
  },
  "errors": null
}
```

## Сценарий 5.4. Получение адреса по uri.

Нужно, когда юзер согласился с подсказкой.

Пример запроса:

http://localhost:32770/api/Goecode/GetGeocodeByUri HTTP_POST

```
{
  "input": "ymapsbm1://geo?data=Cgg1MzA1NzI0MRIg0KDQvtGB0YHQuNGPLCDQr9GA0L7RgdC70LDQstC70Yw,"
}
```

Пример ответа:

```
{
  "success": true,
  "data": {
    "success": true,
    "geoobjects": [
      {
        "formattedAddress": "Россия, Ярославль",
        "toLocalityName": "Россия, Центральный федеральный округ, Ярославская область, городской округ Ярославль, Ярославль",
        "point": {
          "latitude": 57.626559,
          "longitude": 39.893813
        }
      }
    ]
  },
  "errors": null
}
```

## Сценарий 5.5. Получение географии по точке на карте.

Пример запроса:

http://localhost:32770/api/Goecode/GetGeocodeByPoint HTTP_POST

```
{
  "latitude": 57.626559,
  "longitude": 39.893813
}
```

Пример ответа:

```
{
  "success": true,
  "data": {
    "success": true,
    "geoobjects": [
      {
        "formattedAddress": "Россия, Ярославль, Советская площадь",
        "toLocalityName": "Россия, Центральный федеральный округ, Ярославская область, городской округ Ярославль, Ярославль, Советская площадь",
        "point": {
          "latitude": 57.626737,
          "longitude": 39.894263
        }
      }
    ]
  },
  "errors": null
}
```

Важное замечание: в ответе точка может сместиться. Это нормально. Это особенность работы географии.

# Далее идут не core-механики сервиса.

Без таких механик сервис либо бесполезен, либо не будет работать. Но они более шаблонны, и не требуют столь детального описания, как предыдущие.

# Сценарий 100. Сервис вернул ошибку.

Все запросы обрамлены структурой

```
{
  "success": true,
  "data": { // Depends on request  },
  "errors": [
    {
      "code": "string",
      "message": "string",
      "additionalInfo": "string"
    }
  ]
}
```

Пример, что будет, если попытаться создать поездку, но не соблюсти ограничения контракта:

Запрос:

```
{
  "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "authorId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "driverId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "created": "2024-05-20T06:05:05.995Z",
  "availablePlacesCount": 0,
  "paymentMethods": [
    "unknown"
  ],
  "validationMethod": "unknown",
  "validationTimeBeforeDeparture": "01:01:01",
  "afterRideValidationTimeoutAction": "unknown",
  "waypoints": [
    {
      "point": {
        "latitude": 0,
        "longitude": 0
      },
      "fullName": "string",
      "nameToCity": "string",
      "arrival": "2024-05-20T06:05:05.995Z",
      "departure": "2024-05-20T06:05:05.995Z"
    }
  ],
  "legs": [
    {
      "waypointFrom": {
        "latitude": 0,
        "longitude": 0
      },
      "waypointTo": {
        "latitude": 0,
        "longitude": 0
      },
      "priceInRub": 0,
      "isBetweenNeighborPoints": true
    }
  ]
}
```

Ответ:

```
{
  "Success": false,
  "Data": null,
  "Errors": [
    {
      "Code": "RideValidator_PaymentMethodsContainsUnknown",
      "Message": "Способ оплаты Unknown не поддерживается",
      "AdditionalInfo": "PropertyName - PaymentMethods"
    },
    {
      "Code": "RideValidator_TooLittlePassengerSeats",
      "Message": "Количество мест для пассажиров должно быть минимум 1",
      "AdditionalInfo": "PropertyName - AvailablePlacesCount"
    },
    {
      "Code": "RideValidator_ValidationMethodUnknown",
      "Message": "Способ проверки пассажира Unknown не поддерживается",
      "AdditionalInfo": "PropertyName - ValidationMethod"
    },
    {
      "Code": "RideValidator_EmptyWaypoints",
      "Message": "Не заполнены пункты назначения и промежуточные точки поездки",
      "AdditionalInfo": "PropertyName - Waypoints"
    }
  ]
}
```

То есть если ошибка известная, то будет уникальный код ошибки, на который можно завязываться и который не поменяется в дальнейшем (код может исчезнуть или появиться новый, но просто взять и переименоваться - только по согласованию сторон), а также текст на русском для пояснения ошибки.

Если ошибка была неизвестной, неожиданной, то будет

```
{
  "Success": false,
  "Data": null,
  "Errors": [
    {
      "Code": "UnknownError",
      "Message": "Unknown error",
      "AdditionalInfo": null
    }
  ]
}
```

И за деталями уже только в логи.

# Сценарий 101. Чат с поддержкой.

Пользователям доступен чат с поддержкой. Чат должен быть тихим - открываться только по нажатию на него. Храним всю историю общения с поддержкой.

# Сценарий 102. Общий чат поездки.

Групповой чат, доступен менеджеру, водителю и тем пассажирам, чьё участие в поездке подтверждено. Пассажиры могут в дальнейшем покинуть поездку, однако в чате их история сохранится. Чат как чат, ничего особенного. Новым участникам доступны старые сообщения. Если никто ничего не писал, в списке чатов не отображается.

Возможно, в дальнейшем публикация сообщений в чате будет доступна лишь менеджеру и водителю. А может менеджер и водитель сами будут решать, разрешать ли публикацию сообщений в общий чат. Это нужно для защиты от спама и от злоумышленников.

# Сценарий 103. Чат менеджера и водителя с пассажиром.

Групповой чат между менеджером, водителем и пассажиром. Ничего особенного. Чат как чат. Если никто ничего не писал, в списке чатов не отображается.

# Сценарий 104. Оплата.

Банковская карта, qr код.

# Сценарий 105. Личный счёт пользователя.

На случай каких-то проблем мы можем увеличить личный счёт пользователя. К примеру, он обратился к поддержке с претензией, что мы не отобразили уведомление, а он из-за этого потерял свои деньги. Чтобы как-то скомпенсировать его потери, мы можем увеличить личный счёт. В дальнейшем пользователь сможет пользоваться этими деньгами для оплаты поездок.

На текущий момент usecase не нужно реализовывать. Но возможно, надо заложиться на такую фичу сразу, и какие-то подготовительные действия провести.

# Сценарий 106. Отзывы.

Отзывы можно ставить только на ту поездку, в которой пользователь принимал участие.

Оценка по 5-звёздочной системе.

Пассажир оценивает водителя, водитель пассажира. Менеджера оценивать не нужно. (Хотя это немного странно, так как менеджер может участвовать в беседах в поездке. Возможно, в дальнейшем переделаем). Таким образом у пользователя есть 2 шкалы и 2 набора отзывов: как о водителе и как о пассажире.

# Сценарий 107. Оповещения.

## Сценарий 107.1. Оповещения в системе.

Они должны быть. Иметь отметку о прочтении.

## Сценарий 107.2. Внешние оповещения.

Настраиваемо пользователем. Смс, телеграм, ватсап, почта. Может ещё каналы потом добавим.

# Сценарий 108. Мобильная версия.

Нужна. Кровь из носу, но нужна. По функционалу вообще ничем отличаться не должна. Лишь визуалом. Ну и пуш-уведомления по-другому работать должны - в соответствии с мобильной версией.

Нужны мобильные версии и в виде сайта, и в виде андроид и ios приложений на соответствующих площадках.

# Сценарий 109. Тёмная тема.

Нужна. Не критично, но нужна.
