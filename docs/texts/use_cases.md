- [Действующие лица.](#действующие-лица)
- [Сценарий 1. Запрос поездок.](#сценарий-1-запрос-поездок)
	- [Сценарий 1.1. Базовый.](#сценарий-11-базовый)
		- [Сценарий 1.1.1. Фильтры.](#сценарий-111-фильтры)
- [Сценарий 2. Бронирование.](#сценарий-2-бронирование)
	- [Сценарий 2.1. Бронирование с оплатой на сайте.](#сценарий-21-бронирование-с-оплатой-на-сайте)
		- [Сценарий 2.1.1. Водитель подтверждает поездку.](#сценарий-211-водитель-подтверждает-поездку)
		- [Сценарий 2.1.2. Водитель отклоняет поездку.](#сценарий-212-водитель-отклоняет-поездку)
	- [Сценарий 2.2. Бронирование с оплатой на месте.](#сценарий-22-бронирование-с-оплатой-на-месте)
		- [Сценарий 2.2.1. Водитель подтверждает поездку.](#сценарий-221-водитель-подтверждает-поездку)
		- [Сценарий 2.2.2. Водитель отклоняет поездку.](#сценарий-222-водитель-отклоняет-поездку)
	- [Сценарий 2.3. Отмена брони (пассажиром).](#сценарий-23-отмена-брони-пассажиром)
		- [Сценарий 2.3.1. Отмена брони с оплатой на сайте.](#сценарий-231-отмена-брони-с-оплатой-на-сайте)
		- [Сценарий 2.3.2. Отмена брони с оплатой на месте.](#сценарий-232-отмена-брони-с-оплатой-на-месте)
- [Сценарий 3. Поездки.](#сценарий-3-поездки)
	- [Сценарий 3.1. Поездки для водителя.](#сценарий-31-поездки-для-водителя)
		- [Сценарий 3.1.1. Создание поездки.](#сценарий-311-создание-поездки)
			- [Сценарий 3.1.1.1. Сохранение как черновик.](#сценарий-3111-сохранение-как-черновик)
			- [Сценарий 3.1.1.2. Публикация поездки](#сценарий-3112-публикация-поездки)
			- [Сценарий 3.1.1.3. Создание регулярной поездки, сохранение как шаблон.](#сценарий-3113-создание-регулярной-поездки-сохранение-как-шаблон)
				- [Сценарий 3.1.1.3.1. Редактирование перед публикацией регулярной поездки.](#сценарий-31131-редактирование-перед-публикацией-регулярной-поездки)
		- [Сценарий 3.1.2. Редактирование поездки.](#сценарий-312-редактирование-поездки)
			- [Сценарий 3.1.2.1. Редактирование черновика.](#сценарий-3121-редактирование-черновика)
			- [Сценарий 3.1.2.2. Редактирование опубликованной поездки.](#сценарий-3122-редактирование-опубликованной-поездки)
			- [Сценарий 3.1.2.3. Удаление поездки.](#сценарий-3123-удаление-поездки)
				- [Сценарий 3.1.2.3.1. Удаление пустой (без пассажиров) поездки.](#сценарий-31231-удаление-пустой-без-пассажиров-поездки)
				- [Сценарий 3.1.2.3.2. Удаление поездки с пассажирами.](#сценарий-31232-удаление-поездки-с-пассажирами)
		- [Сценарий 3.1.3. Редактирование шаблона.](#сценарий-313-редактирование-шаблона)
		- [Сценарий 3.1.4. Валидация пассажира.](#сценарий-314-валидация-пассажира)
	- [Сценарий 3.2. Поездки для менеджера.](#сценарий-32-поездки-для-менеджера)
		- [Сценарий 3.2.1. Создание поездки.](#сценарий-321-создание-поездки)
			- [Сценарий 3.2.1.1. Сохранение как черновик.](#сценарий-3211-сохранение-как-черновик)
			- [Сценарий 3.2.1.2. Публикация поездки](#сценарий-3212-публикация-поездки)
			- [Сценарий 3.2.1.3. Создание регулярной поездки, сохранение как шаблон.](#сценарий-3213-создание-регулярной-поездки-сохранение-как-шаблон)
				- [Сценарий 3.2.1.3.1. Редактирование перед публикацией шаблонной поездки.](#сценарий-32131-редактирование-перед-публикацией-шаблонной-поездки)
		- [Сценарий 3.2.2. Редактирование поездки.](#сценарий-322-редактирование-поездки)
			- [Сценарий 3.2.2.1. Редактирование черновика.](#сценарий-3221-редактирование-черновика)
			- [Сценарий 3.2.2.2. Редактирование опубликованной поездки.](#сценарий-3222-редактирование-опубликованной-поездки)
			- [Сценарий 3.2.2.3. Удаление поездки.](#сценарий-3223-удаление-поездки)
				- [Сценарий 3.2.2.3.1. Удаление пустой (без пассажиров) поездки.](#сценарий-32231-удаление-пустой-без-пассажиров-поездки)
				- [Сценарий 3.2.2.3.2. Удаление поездки с пассажирами.](#сценарий-32232-удаление-поездки-с-пассажирами)
		- [Сценарий 3.2.3. Редактирование шаблона.](#сценарий-323-редактирование-шаблона)
		- [Сценарий 3.2.4. Валидация пассажира.](#сценарий-324-валидация-пассажира)
- [Сценарий 4. Действия с аккаунтом.](#сценарий-4-действия-с-аккаунтом)
	- [Сценарий 4.1. Регистрация.](#сценарий-41-регистрация)
	- [Сценарий 4.2. Редактирование аккаунта.](#сценарий-42-редактирование-аккаунта)
	- [Сценарий 4.3. Приобретение статуса водителя.](#сценарий-43-приобретение-статуса-водителя)
	- [Сценарий 4.4. Заполнение данных об автомобиле.](#сценарий-44-заполнение-данных-об-автомобиле)
	- [Сценарий 4.5. Связь менеджера и водителя.](#сценарий-45-связь-менеджера-и-водителя)
		- [Сценарий 4.5.1. Добавление связи.](#сценарий-451-добавление-связи)
		- [Сценарий 4.5.2. Удаление связи.](#сценарий-452-удаление-связи)
	- [Сценарий 4.6. Фото.](#сценарий-46-фото)
- [Далее идут не core-механики сервиса.](#далее-идут-не-core-механики-сервиса)
- [Сценарий 100. Чат с поддержкой.](#сценарий-100-чат-с-поддержкой)
- [Сценарий 101. Общий чат поездки.](#сценарий-101-общий-чат-поездки)
- [Сценарий 102. Чат менеджера и водителя с пассажиром.](#сценарий-102-чат-менеджера-и-водителя-с-пассажиром)
- [Сценарий 103. Оплата.](#сценарий-103-оплата)
- [Сценарий 104. Личный счёт пользователя.](#сценарий-104-личный-счёт-пользователя)
- [Сценарий 105. Отзывы.](#сценарий-105-отзывы)
- [Сценарий 106. Оповещения.](#сценарий-106-оповещения)
	- [Сценарий 106.1. Оповещения в системе.](#сценарий-1061-оповещения-в-системе)
	- [Сценарий 106.2. Внешние оповещения.](#сценарий-1062-внешние-оповещения)
- [Сценарий 107. Мобильная версия.](#сценарий-107-мобильная-версия)
- [Сценарий 108. Тёмная тема.](#сценарий-108-тёмная-тема)


# Действующие лица.

1. WordPress. Отвечает за популярные штуки и фронт. Например, за чат, за сервисы оплаты.
2. GeoService. Отвечает за основной функционал, связанный с географией.
3. DriverService. Отвечает за функционал, связанный с проверкой водителей.
4. Юзер. Он же пользователь. Может быть водителем, пассажиром, а также менеджером. На всё 1 аккаунт, а роль различается в зависимости от ситуации.

# Сценарий 1. Запрос поездок.

## Сценарий 1.1. Базовый.

Юзер заходит на сайт. Выбирает в фильтрах интересующие его фильтры. Фильтры будут рассмотрены отдельно.

WordPress получает запрос пользователя. Пересылает его GeoService'у.

GeoService смотрит по БД, что можно дать юзеру. Отдаёт WordPress'у.

WordPress отдаёт ответ юзеру. Вынужденная мера: WordPress сверяется в ответе. Если в поездке нет мест или их недостаточно (поиск шёл на 3 места сразу, например), показывает поездку серым. По идее такие поездки не должны отображаться.

### Сценарий 1.1.1. Фильтры.

Wordpress отображает пользователю и в дальнейшем передаёт GeoService'у следующие параметры:

* Сортировка. По возрастанию, убыванию. По цене, удалённости старта, удалённости конца, времени старта, времени конца.
* Фильтрация.
  + По точке и удалённости от неё старта (обязательный параметр)
  + По точке и удалённости от неё конца (обязательный)
  + Минимального времени выезда (обязательный, дефолтно - текущее время)
  + Максимального времени выезда (не обязательный)
  + Минимального времени прибытия (не обязательный)
  + Максимального времени прибытия (обязательный)
  + По цене минимальной (не обязательный)
  + По цене максимальной (не обязательный)
  + По кол-ву свободных мест (обязательный, дефолтно - 1)
  + Способам оплаты (обязательный, дефолтно "любой способ")
  + По подтверждению поездки водителем (обязательный, дефолтно "можно так, можно так")

> По времени максимальный период, который должен получиться - две недели (задаётся конфигами).
> 
> Также по времени - всё время WordPress передаёт с часовым поясом +0.

# Сценарий 2. Бронирование.

Бронирование невозможно совершить над поездкой, у которой старт точки отправления в прошлом (проверяет GeoService в момент выдачи поискового запроса и WordPress в момент открытия поездки и бронирования), над отменённой (проверяет GeoService в момент выдачи поискового запроса и WordPress в момент открытия поездки и бронирования), над той, где водитель отказался вести конкретного пассажира (проверяет WordPress в момент открытия поездки и бронирования), свою поездку (проверяет GeoService в момент выдачи поискового запроса и WordPress в момент открытия поездки и бронирования).

В момент бронирования пассажир проходит капчу.

## Сценарий 2.1. Бронирование с оплатой на сайте.

> У оплаты на сайте есть проблема. Если водитель хочет предварительно посмотреть, кто едет (отзывы почитать, всё такое). Юзер-пассажир в таком случае не застрахован от отказа. Имхо, это неизбежное зло такого сервиса.

Пассажир выбрал поездку. Нажал на "забронировать", выбрал оплату картой.

WordPress предоставил способ оплаты. Фрейм с оплатой, qr код - для сценария не важно. Важно, что средства не списываются, а замораживаются.

Пассажир оплатил бронь. WordPress получил отмашку от сервиса оплаты, обновил фрейм. Обновил кол-во доступных мест в поездке в своей БД. Отправил в брокер на GeoService сообщение об изменении кол-ва доступных мест в поездке.

WordPress шлёт все уведомления. Пуш, тг, почта, смс. Водителю.

### Сценарий 2.1.1. Водитель подтверждает поездку.

Подтверждение может быть как ручным, так и автоматическим (по истечении времени на подтверждение).

WordPress меняет статус бронирования на подтверждённый.

### Сценарий 2.1.2. Водитель отклоняет поездку.

Отказ может быть как ручным, так и автоматическим (по истечении времени на отказ).

Бронь снимается. WordPress шлёт все уведомления. Пуш, тг, почта, смс. Пассажиру. WordPress возвращает деньги пассажиру. Поездка помечается отклонённой - чтобы пассажир не мог повторно забронировать эту поездку.

## Сценарий 2.2. Бронирование с оплатой на месте.

Пассажир выбрал поездку. Нажал на "забронировать", выбрал оплату на месте.

Пассажир подтвердил намерения, уверенность в дате поездки. Защита от дурака. Фрейм "Проверьте введённые данные".

WordPress обновил кол-во доступных мест в поездке в своей БД. Отправил в брокер на GeoService сообщение об изменении кол-ва доступных мест в поездке.

WordPress шлёт все уведомления. Пуш, тг, почта, смс.

### Сценарий 2.2.1. Водитель подтверждает поездку.

Подтверждение может быть как ручным, так и автоматическим (по истечении времени на подтверждение).

WordPress меняет статус бронирования на подтверждённый.

### Сценарий 2.2.2. Водитель отклоняет поездку.

Отказ может быть как ручным, так и автоматическим (по истечении времени на отказ).

Бронь снимается. WordPress шлёт все уведомления. Пуш, тг, почта, смс. Пассажиру. Поездка помечается отклонённой - чтобы пассажир не мог повторно забронировать эту поездку.

## Сценарий 2.3. Отмена брони (пассажиром).

### Сценарий 2.3.1. Отмена брони с оплатой на сайте.

Пассажир выбрал поездку. Нажал на "Отменить бронь".

Защита от дурака. Фрейм "Выберете причину отмены поездки".

WordPress возвращает пассажиру его средства. Отмечает в своей бд, что юзер сделал отмену (понятно, что оно и так есть в истории денежных транзакций, но важно, чтобы отмены можно было потом посчитать).

В случае большого числа отмен за последний период (скорее всего, месяц), выдать предупреждение. В случае превышения максимального числа отмен за период, залочить юзера.

WordPress обновил кол-во доступных мест в поездке в своей БД. Отправил в брокер на GeoService сообщение об изменении кол-ва доступных мест в поездке.

### Сценарий 2.3.2. Отмена брони с оплатой на месте.

Пассажир выбрал поездку. Нажал на "Отменить бронь".

Защита от дурака. Фрейм "Выберете причину отмены поездки".

WordPress отмечает в своей бд, что юзер сделал отмену.

В случае большого числа отмен за последний период (скорее всего, месяц), выдать предупреждение. В случае превышения максимального числа отмен за период, залочить юзера.

WordPress обновил кол-во доступных мест в поездке в своей БД. Отправил в брокер на GeoService сообщение об изменении кол-ва доступных мест в поездке.

# Сценарий 3. Поездки.

Поездка для создания и редактирования доступна водителю и менеджеру. При этом поездка, созданная менеджером, недоступна для редактирования водителю, если только менеджер не указал обратное.

## Сценарий 3.1. Поездки для водителя.

### Сценарий 3.1.1. Создание поездки.

Предусловия:

- у водителя нет ни своих запланированных поездок на указываемое время, ни броней на чужие поездки на указанное время. Под "указанным временем" понимается пересечение времён.

Дополнение:

- Водитель может начать планирование поездки даже если не имеет статус водителя (не ввёл либо не дождался проверки водительского удостоверения) или если есть пересечения времён. В таком случае WordPress показывает водителю предупреждение. Сама поездка сохраняется в виде черновика. WordPress не даёт перевести статус в какой-либо другой (исключение - deleted).

Водитель нажал на "Запланировать поездку".

WordPress открывает страницу редактирования поездки.

Водитель вводит все необходимые данные. Дата-время начала поездки, каждой промежуточной точки, окончания поездки. Промежуточные точки. Транспортное средство. Кол-во доступных для пассажиров мест. Комментарий к поездке (например, "Места в багаже практически нет. С большими сумками не бронируйте"). Цены на поездку целиком и на отдельные участки (про цены будет отдельный пункт). Способы оплаты. Моментальное подтверждение или с валидацией водителем. Максимальное время на валидацию пассажира. Принимать без валидации либо закрыть для бронирования поездку по истечении указанного промежутка.

WordPress проверяет данные. В случае нарушений показывает предупреждения.

В момент начала ввода точек WordPress отправляет запросы GeoService для получения подсказок.

В момент ввода точек (то есть когда юзер окончательно ввёл адрес для точки - нажал enter, tab или просто ушёл на другое поле ввода) WordPress отправляет запросы GeoService для получения рекомендаций цен.

#### Сценарий 3.1.1.1. Сохранение как черновик.

Водитель нажимает "Сохранить как черновик". WordPress сохраняет поездку, оповещая об этом водителя.

#### Сценарий 3.1.1.2. Публикация поездки

Водитель нажимает "Опубликовать поездку". Защита от дурака - фрейм "Проверьте введённые данные". WordPress сохраняет изменения. Шлёт сообщение на GeoService о создании поездки.

#### Сценарий 3.1.1.3. Создание регулярной поездки, сохранение как шаблон.

Водитель ставит галочку "Поездка регулярна". WordPress показывает дополнительные параметры поездки. Такие как "По дням недели", "По чётным числам месяца", "По нечётным числам месяца", "Раз в несколько дней", "Подтверждать создание поездки", "Создавать несколько поездок наперёд", "Создавать поездки за несколько дней до старта", "Шаблон активен". При активации галочки "Поездка регулярна" кнопка "Опубликовать поездку" становится неактивной. Вместо неё появляется кнопка "Опубликовать следующую поездку: Город А - Город Б, yyyy-MM-ddTHH:mm - yyyy-MM-ddTHH:mm". Вместо кнопки "Сохранить как черновик" появляется кнопка "Сохранить шаблон".

##### Сценарий 3.1.1.3.1. Редактирование перед публикацией регулярной поездки.

Если водитель пожелал подтверждать создание поездок, то создаваемые по шаблону поездки сохраняются как черновики. В том числе в момент нажатия на кнопку "Опубликовать следующую поездку...". Только в последнем случае сразу открывается фрейм с редактированием черновика.

### Сценарий 3.1.2. Редактирование поездки.

Как было упомянуто выше, редактирование водителю доступно, если он сам себе создаёт поездку, или если менеджер разрешил редактирование.

#### Сценарий 3.1.2.1. Редактирование черновика.

В этом случае никаких ограничений на редактирование не накладывается. Водитель редактирует, как ему удобно.

WordPress сохраняет изменения по нажатию на кнопку "Сохранить изменения". WordPress показывает юзеру плашку об успешном сохранении изменений.

#### Сценарий 3.1.2.2. Редактирование опубликованной поездки.

Доступно редактирование лишь комментария и кол-ва доступных мест. При изменении комментария при сохранении изменений всем юзерам-пассажирам в этой поездке WordPress шлёт уведомление об изменениях. Подробнее уведомления будут рассмотрены отдельно.

При редактировании кол-ва доступных мест WordPress проверяет возможность таких изменений. К примеру, если заявлено 4 места, из них 2 уже заняты, а водитель хочет снизить кол-во доступных мест до 2, то всё пройдёт успешно. До 1 - ошибка. До 3 - успешно. Хочет увеличить - будет проверка такой возможности в соответствии с выбранным авто.

#### Сценарий 3.1.2.3. Удаление поездки.

##### Сценарий 3.1.2.3.1. Удаление пустой (без пассажиров) поездки.

Водитель жмёт кнопу "Удалить поездку". Защита от дурака - фрейм "Укажите причину отмены". WordPress отмечает в своей БД поездку как удалённую. WordPress шлёт на GeoService сообщение об отмене поездки. GeoService помечает поездку удалённой. WordPress сообщает юзеру об успешном удалении поездки.

##### Сценарий 3.1.2.3.2. Удаление поездки с пассажирами.

Водитель жмёт кнопку "Удалить поездку". Защита от дурака - фрейм "Укажите причину отмены". Наверху этого фрейма светится предупреждение о возможности бана. Водитель подтверждает серьёзность своих намерений. Всем пассажирам рассылается уведомление и по необходимости возвращаются деньги.

### Сценарий 3.1.3. Редактирование шаблона.

Ничего интересного. Все поля доступны на редактирование. Важно, что это никак не аффектит уже созданные по шаблону поездки.

### Сценарий 3.1.4. Валидация пассажира.

Важный аспект:

- Без валидации пассажир не занимает место в машине. То есть может сложиться ситуация, что будет забронировано 5 мест из 4. В таком случае одному человеку придётся отказать.

Если водитель пожелал валидировать пассажира, то в момент брони поездки пассажиром водитель получает уведомление о бронировании. Далее водитель должен утвердить участие пассажира. Валидация должна быть не позднее, чем за указанный промежуток в параметре "Максимальное время на валидацию пассажира". При отсутствии валидации к указанному времени применить указанное действие (принимать всех без валидации или отказывать всем).

В случае валидации пассажира (не важно, ручной или автоматической) идёт проверка на наличие свободных мест для остальных забронировавших. Если мест не остаётся, оставшимся людям приходит отказ.

## Сценарий 3.2. Поездки для менеджера.

Менеджер может создавать поездки для своих водителей (так как отношение водителей и менеджеров будет рассмотрено позже, то кратко упомяну здесь: связь многие ко многим. Один водитель может ссылаться на 0..n менеджеров, менеджер может ссылаться на 0..n водителей).

### Сценарий 3.2.1. Создание поездки.

Глобально создание поездки менеджером отличается от создания поездки водителем тем, что менеджер может выбрать водителя на поездку и имеет временной лаг на редактирование поездки даже после публикации.

WordPress открывает страницу редактирования поездки.

Менеджер вводит все необходимые данные. Дата-время начала поездки, каждой промежуточной точки, окончания поездки. Промежуточные точки. Транспортное средство. Кол-во доступных для пассажиров мест. Комментарий к поездке (например, "Места в багаже практически нет. С большими сумками не бронируйте"). Цены на поездку целиком и на отдельные участки (про цены будет отдельный пункт). Способы оплаты. Моментальное подтверждение или с валидацией менеджером или водителем. Максимальное время на валидацию пассажира. Принимать без валидации либо закрыть для бронирования поездку по истечении указанного промежутка. Водитель. Возможность редактирования поездки водителем. Возможность валидации пассажира водителем.

Напротив параметров "Водитель", "Транспортное средство" появляется параметр "Окончательное значение". Если оно стоит в false, то пассажирам в этом месте показывается предупреждение, что выбор не окончательный. Параметр "Окончательное значение" доступен для изменения с false на true, но не наоборот (подробнее в пункте о редактировании поездки).

Менеджер может указать как своё транспортное средство, так и транспортное средство водителя.

WordPress проверяет данные. В случае нарушений показывает предупреждения.

В момент начала ввода точек WordPress отправляет запросы GeoService для получения подсказок.

В момент ввода точек (то есть когда юзер окончательно ввёл адрес для точки - нажал enter, tab или просто ушёл на другое поле ввода) WordPress отправляет запросы GeoService для получения рекомендаций цен.

WordPress показывает ещё 1 параметр поездки: максимальное время на подтверждение данных. Хоть и является голым DateTime, WordPress показывает заранее заготовленные варианты: 6 часов до поездки, 12 часов до поездки, 24 часа до поездки, 3 дня до поездки, неделя до поездки. Этот параметр тесно связан с параметром "Окончательное значение". Если к указанному времени поле пустое - поездка удаляется (с вытекающей возможностью бана). Если поле не пустое, то насильственно ставится параметр "Окончательное значение".

#### Сценарий 3.2.1.1. Сохранение как черновик.

Менеджер нажимает "Сохранить как черновик". WordPress сохраняет поездку, оповещая об этом менеджера (в будущем и водителя).

#### Сценарий 3.2.1.2. Публикация поездки

Менеджер нажимает "Опубликовать поездку". Защита от дурака - фрейм "Проверьте введённые данные". WordPress сохраняет изменения. Шлёт сообщение на GeoService о создании поездки.

#### Сценарий 3.2.1.3. Создание регулярной поездки, сохранение как шаблон.

Менеджер ставит галочку "Поездка регулярна". WordPress показывает дополнительные параметры поездки. Такие как "По дням недели", "По чётным числам месяца", "По нечётным числам месяца", "Раз в несколько дней", "Подтверждать создание поездки", "Создавать несколько поездок наперёд", "Создавать поездки за несколько дней до старта", "Шаблон активен". При активации галочки "Поездка регулярна" кнопка "Опубликовать поездку" становится неактивной. Вместо неё появляется кнопка "Опубликовать следующую поездку: Город А - Город Б, yyyy-MM-ddTHH:mm - yyyy-MM-ddTHH:mm". Вместо кнопки "Сохранить как черновик" появляется кнопка "Сохранить шаблон".

##### Сценарий 3.2.1.3.1. Редактирование перед публикацией шаблонной поездки.

Если менеджер пожелал подтверждать создание поездок, то создаваемые по шаблону поездки сохраняются как черновики. В том числе в момент нажатия на кнопку "Опубликовать следующую поездку...". Только в последнем случае сразу открывается фрейм с редактированием черновика.


### Сценарий 3.2.2. Редактирование поездки.

Как было упомянуто выше, редактирование водителю доступно, только если менеджер разрешил редактирование. В противном случае редактирование доступно лишь менеджеру.

Редактирование менеджером отличается лишь возможностью сменить водителя и машину (если только не стоит галочка "Окончательное значение"). В будущем появится возможность отсылать уведомление водителю об изменениях поездки.

#### Сценарий 3.2.2.1. Редактирование черновика.

В этом случае никаких ограничений на редактирование не накладывается. Менеджер редактирует, как ему удобно.

WordPress сохраняет изменения по нажатию на кнопку "Сохранить изменения". WordPress показывает юзеру плашку об успешном сохранении изменений.

#### Сценарий 3.2.2.2. Редактирование опубликованной поездки.

Доступно редактирование лишь комментария, кол-ва доступных мест, и водителя и машину (если только не стоит галочка "Окончательное значение"). При изменении комментария при сохранении изменений всем юзерам-пассажирам в этой поездке WordPress шлёт уведомление об изменениях. Подробнее уведомления будут рассмотрены отдельно.

При редактировании кол-ва доступных мест WordPress проверяет возможность таких изменений. К примеру, если заявлено 4 места, из них 2 уже заняты, а водитель хочет снизить кол-во доступных мест до 2, то всё пройдёт успешно. До 1 - ошибка. До 3 - успешно. Хочет увеличить - будет проверка такой возможности в соответствии с выбранным авто.

В будущем водителю будут приходить уведомления.

#### Сценарий 3.2.2.3. Удаление поездки.

Удалять поездку может только менеджер.

##### Сценарий 3.2.2.3.1. Удаление пустой (без пассажиров) поездки.

Менеджер жмёт кнопу "Удалить поездку". Защита от дурака - фрейм "Укажите причину отмены". WordPress отмечает в своей БД поездку как удалённую. WordPress шлёт на GeoService сообщение об отмене поездки. GeoService помечает поездку удалённой. WordPress сообщает юзеру об успешном удалении поездки.

##### Сценарий 3.2.2.3.2. Удаление поездки с пассажирами.

Менеджер жмёт кнопку "Удалить поездку". Защита от дурака - фрейм "Укажите причину отмены". Наверху этого фрейма светится предупреждение о возможности бана. Менеджер подтверждает серьёзность своих намерений. Всем пассажирам рассылается уведомление и по необходимости возвращаются деньги.

### Сценарий 3.2.3. Редактирование шаблона.

Ничего интересного. Все поля доступны на редактирование. Важно, что это никак не аффектит уже созданные по шаблону поездки.

### Сценарий 3.2.4. Валидация пассажира.

Важный аспект:

- Без валидации юзер не занимает место в машине. То есть может сложиться ситуация, что будет забронировано 5 мест из 4. В таком случае одному человеку придётся отказать.
- Валидация пассажира доступна менеджеру. При установленной галочке о валидации пассажира водителем, такая возможность появляется и у водителя.

Если менеджер пожелал валидировать пассажира, то в момент брони поездки пассажиром менеджер получает уведомление о бронировании. Далее менеджер должен утвердить участие пассажира. Валидация должна быть не позднее, чем за указанный промежуток в параметре "Максимальное время на валидацию пассажира". При отсутствии валидации к указанному времени применить указанное действие (принимать всех без валидации или отказывать всем).

В случае валидации пассажира (не важно, ручной или автоматической) идёт проверка на наличие свободных мест для остальных забронировавших. Если мест не остаётся, оставшимся людям приходит отказ.

# Сценарий 4. Действия с аккаунтом.

## Сценарий 4.1. Регистрация.

Аккаунт един для пассажира, водителя и менеджера. Регистрация идёт по номеру телефона. Дефолтно делаем двухфакторную аутентификацию. Юзер может от неё отказаться.

> Можно зарегистрироваться через госуслуги. Это на будущее.

При регистрации необходимо указать полное ФИО. Есть галочка "Скрывать настоящие данные" - в таком случае пассажирам и водителям отображаться должно лишь первых 3 символа фамилии (печально получится, если фамилия короче. Но пока забиваем на этот кейс), 3 звёздочки, инициалы и пол.

Пол. Можно не указывать.

Дата рождения. Можно не указывать.

Почта. Можно не указывать. Если почта есть - становится активной галочка "Получать новости на почту".

Прохождение капчи.

## Сценарий 4.2. Редактирование аккаунта.

На этапе редактирования аккаунта можно отредактировать все поля. А также можно ввести паспортные данные. Паспортные данные являются обязательными для приобретения статуса водителя. При наличии паспортных данных нельзя поменять персональные данные (например, имя) - данные должны соответствовать паспортным. Однако можно ввести новый паспорт - тогда и персональные данные сменить можно.

## Сценарий 4.3. Приобретение статуса водителя.

Как такового статуса водителя нет. Просто не имея данных о транспортном средстве, о водительском удостоверении не получится опубликовать поездку.

Будущий водитель заполняет данные о водительском удостоверении. Заполняет капчу. WordPress отправляет запрос в DriverService на проверку данных водителя. Проверка происходит хоть и быстро, но не моментально. Водитель вынужден ждать.

## Сценарий 4.4. Заполнение данных об автомобиле.

На одном аккаунте может быть несколько транспортных средств и одно транспортное средство может встретиться у разных людей.

При заполнении данных о транспортном средстве пользователь вводит только VIN номер. И капчу. Все прочие данные (список будет ближе к реализации DriverService. Но однозначно там есть регистрационный номер, кол-во мест (всего, включая водительское), цвет (если авто зарегистрировано в рф)) мы заполняем самостоятельно - эти данные предоставит DriverService. Пользователь может только через письмо поддержке сообщить, что данные неверны. Как будем разруливать - на месте разберёмся.

Пользователь вправе поставить галочку "скрывать регистрационный номер".

## Сценарий 4.5. Связь менеджера и водителя.

Один менеджер может управлять несколькими водителями и один водитель может подчиняться нескольким менеджерам.

### Сценарий 4.5.1. Добавление связи.

Инициатором добавления связи является менеджер.

Менеджер нажимает на "Добавить водителя", вводит его id (uuid). WordPress показывает ФИО пользователя. Важно, что показываются только люди, имеющие водительское удостоверение. Менеджер подтверждает корректность ФИО водителя.

WordPress отправляет водителю запрос на добавление менеджера. У водителя есть 24 часа (время настраивается конфигами) на то, чтобы принять запрос. В противном случае запрос считается просроченным. Важно, что если уже есть запрос этому водителю от этого менеджера, повторно запрос не отправляется, а менеджеру показывается предупреждение, что запрос был отправлен ранее и всё ещё действителен.

Водитель принимает запрос.

### Сценарий 4.5.2. Удаление связи.

Удалить связь могут как менеджер, так и водитель.

В случае удаления связи отменяются поездки, где водитель указан с пометкой "Финальное значение", а также вносятся изменения в шаблоны поездок, где был указан этот водитель - там ставится пустое значение. Счётчик нарушений за такую отмену поездок начисляется и водителю, и менеджеру.

При удалении связи необходимо пройти защиту от дурака - указать причину удаления, а также пройти капчу.

## Сценарий 4.6. Фото.

Пользователь вправе выложить 1 фото себя и до 10 фото каждого автомобиля. При добавлении фото, нарушающих правила пользования сервисом - бан сразу, без всяких счётчиков. Проверка фото в ручном режиме (по крайней мере пока).

# Далее идут не core-механики сервиса.

Без таких механик сервис либо бесполезен, либо не будет работать. Но они более шаблонны, и не требуют столь детального описания, как предыдущие.

# Сценарий 100. Чат с поддержкой.

Пользователям доступен чат с поддержкой. Чат должен быть тихим - открываться только по нажатию на него. Храним всю историю общения с поддержкой.

# Сценарий 101. Общий чат поездки.

Групповой чат, доступен менеджеру, водителю и тем пассажирам, чьё участие в поездке подтверждено. Пассажиры могут в дальнейшем покинуть поездку, однако в чате их история сохранится. Чат как чат, ничего особенного. Новым участникам доступны старые сообщения. Если никто ничего не писал, в списке чатов не отображается.

Возможно, в дальнейшем публикация сообщений в чате будет доступна лишь менеджеру и водителю. А может менеджер и водитель сами будут решать, разрешать ли публикацию сообщений в общий чат. Это нужно для защиты от спама и от злоумышленников.

# Сценарий 102. Чат менеджера и водителя с пассажиром.

Групповой чат между менеджером, водителем и пассажиром. Ничего особенного. Чат как чат. Если никто ничего не писал, в списке чатов не отображается.

# Сценарий 103. Оплата.

Банковская карта, qr код.

# Сценарий 104. Личный счёт пользователя.

На случай каких-то проблем мы можем увеличить личный счёт пользователя. К примеру, он обратился к поддержке с претензией, что мы не отобразили уведомление, а он из-за этого потерял свои деньги. Чтобы как-то скомпенсировать его потери, мы можем увеличить личный счёт. В дальнейшем пользователь сможет пользоваться этими деньгами для оплаты поездок.

На текущий момент usecase не нужно реализовывать. Но возможно, надо заложиться на такую фичу сразу, и какие-то подготовительные действия провести.

# Сценарий 105. Отзывы.

Отзывы можно ставить только на ту поездку, в которой пользователь принимал участие.

Оценка по 5-звёздочной системе.

Пассажир оценивает водителя, водитель пассажира. Менеджера оценивать не нужно. (Хотя это немного странно, так как менеджер может участвовать в беседах в поездке. Возможно, в дальнейшем переделаем). Таким образом у пользователя есть 2 шкалы и 2 набора отзывов: как о водителе и как о пассажире.

# Сценарий 106. Оповещения.

## Сценарий 106.1. Оповещения в системе.

Они должны быть. Иметь отметку о прочтении.

## Сценарий 106.2. Внешние оповещения.

Настраиваемо пользователем. Смс, телеграм, ватсап, почта. Может ещё каналы потом добавим.

# Сценарий 107. Мобильная версия.

Нужна. Кровь из носу, но нужна. По функционалу вообще ничем отличаться не должна. Лишь визуалом. Ну и пуш-уведомления по-другому работать должны - в соответствии с мобильной версией.

Нужны мобильные версии и в виде сайта, и в виде андроид и ios приложений на соответствующих площадках.

# Сценарий 108. Тёмная тема.

Нужна. Не критично, но нужна.
